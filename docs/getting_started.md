# Installation

To install the software, ensure you have Python2.7 or Python3.5+ or higher
installed on your computer. If using Windows, it's recommended to use [Anaconda](https://www.continuum.io/downloads), because of the computational
dependencies that are difficult to install on Windows (scipy, numpy, etc.).

Then, preferably in a virtual environment, install BBMD:

    pip install https://github.com/kanshao/bbmd

## Compiling STAN models

After installation, dose-response models require compilation on your computer.
Compile models using the following command:

    compile_stan_models

As an alternative, you can also compile the models within a python session:

```python
import bbmd
bbmd.compile_stan()
```

This should take approximately 10-30 minutes to compile all the BBMD models.

## Using BBMD

In a Python session, import bbmd:

```python
import bbmd
```

Next, we create a new bbmd session. A Session is a collection of different
dose-response models which may be applied to a single dataset:

```python
session = bbmd.Session(
    name='My session name',
    mcmc_iterations=10000,
    mcmc_num_chains=4,
    mcmc_warmup_fraction=0.25,
    seed=12345,
)
```

All inputs are optional; default values are shown above (except name, which is
generated by taking the current date and time).

### Adding data

To add dichotomous data:

```python
session.add_dichotomous_data(
    dose=[0, 1.96, 5.69, 29.75],
    n=[75, 49, 50, 49],
    incidence=[5, 1, 3, 14]
)
```

To add summary continuous data:

```python
session.add_continuous_summary_data(
    dose=[0, 10, 50, 150, 400],
    n=[111, 142, 143, 93, 42],
    response=[2.112, 2.095, 1.956, 1.587, 1.254],
    stdev=[0.235, 0.209, 0.231, 0.263, 0.159]
)
```

To add individual continuous data:

```python
session.add_continuous_individual_data(
    dose=[0, 0, 0, ..., 100, 100, 100],
    response=[0.4, 0.7, 0.2, ..., 13.1, 16.2, 18.5],
)
```

To get z- and p-value for trend-test (dichotomous-only), after adding data:

```python
z, pvalue = session.get_trend_test()
```

### Adding models

To add dichotomous models to your session:

```python
import bbmd.models.dichotomous as dmodels

session.add_models(
    dmodels.Gamma(),
    dmodels.Logistic(),
    dmodels.LogLogistic(pwr_lbound=0),
    dmodels.LogProbit(),
)
```

Or for a continuous models:

```python
import bbmd.models.continuous as cmodels

session.add_models(
    cmodels.Exponential2(),
    cmodels.Hill(),
    cmodels.Power(pwr_lbound=0),
    cmodels.MichaelisMenten(),
)
```

You may optionally specify a `name` parameter for each model; this parameter
will be used for reporting purposes (which may be helpful if you're running the
same model with default parameter settings).

### Executing the software

After models have been compiled above, they can be used on Sessions.
After creating a session, and adding data and models to that session execute:

```python
session.execute()
```

### Adding BMD estimates

To add dichotomous BMD estimates:

```python
import bbmd.bmr.dichotomous as dbmr

session.add_bmrs(
    dbmr.Extra(
        bmr=0.1,
        priors=[1, 1, 1, 1, 1],
    ),
    dbmr.Added(
        bmr=0.1,
        priors=[1, 1, 1, 1, 1],
    )
)
```

To add continuous BMD estimates:

```python
import bbmd.bmr.continuous as cbmr

session.add_bmrs(
    cbmr.CentralTendencyRelativeChange(
        adversity=0.1,
        priors=[1, 1, 1, 1, 1],
    ),
    cbmr.CentralTendencyAbsoluteChange(
        adversity=0.1,
        priors=[1, 1, 1, 1, 1],
    ),
    cbmr.CentralTendencyCutoff(
        adversity=0.1,
        priors=[1, 1, 1, 1, 1],
    ),
    cbmr.HybridControlPercentile(
        adversity=0.1,
        bmr=0.1,
        priors=[1, 1, 1, 1, 1],
    ),
    cbmr.HybridAbsoluteCutoff(
        adversity=0.1,
        bmr=0.1,
        priors=[1, 1, 1, 1, 1],
    )
)
```

With continuous models, some adversity-values are dataset specific. To view valid domain-range for adversity values, ensure that you session has a dataset which has been added, then run the command:

```python
session.get_bmr_adversity_value_domains()
```

To calculate bmrs:

```python
session.calculate_bmrs()
```

### Generating reports

To generate a Microsoft Word output formatted report, use

```python
session.export_word_report('~/Desktop/output.docx')
```

To generate a summary report (in text of JSON):

```python
session.export_report('~/Desktop/report.txt')
session.export_report('~/Desktop/report.json', format='json')
```

To generate a report of model parameters (in tab-delimited or Excel):

```python
session.export_parameters('~/Desktop/parameters.txt')
session.export_parameters('~/Desktop/parameters.xlsx', format='xlsx')
```

To generate a summary of benchmark dose-estimates (in tab-delimited or Excel):

```python
session.export_bmds('~/Desktop/bmds.txt')
session.export_bmds('~/Desktop/bmds.xlsx', format=xlsx)
```

### Batch processing

For batch processing, you can clone the setup for a session. This will clone the Session setup, as well as the models. It does not copy the dataset or results. An example batch script is as follows:

```python
import bbmd
import bbmd.models.dichotomous as dmodels

# create a list of different datasets
datasets = [
    {
        "dose": [0, 1.96, 5.69, 29.75],
        "n": [75, 49, 50, 49],
        "incidence": [5, 1, 3, 14]
    },
    {
        "dose": [0, 1.96, 5.69, 29.75],
        "n": [75, 49, 50, 49],
        "incidence": [3, 13, 17, 22]
    },
]

# create a template which can be re-used for multiple runs
template = bbmd.Session(
    mcmc_iterations=10000,
    mcmc_num_chains=4,
    mcmc_warmup_fraction=0.25,
    seed=12345,
)

template.add_models(
    dmodels.Logistic(),
    dmodels.LogLogistic(),
    dmodels.LogProbit(),
    dmodels.Probit(),
    dmodels.Multistage2(),
)

template.add_bmrs(
    dbmr.Extra(
        bmr=0.1,
        priors=[1, 1, 1, 1, 1],
    )
)

# execute each run and generate reports for each
for i, dataset in enumerate(datasets):
    session = template.copy_as_template()
    session.add_dichotomous_data(**dataset)
    session.execute()
    session.calculate_bmrs()
    session.export_model_fits("~/Desktop/{}-model_fits.txt".format(i))
    session.export_bmd("~/Desktop/{}-bmd.txt".format(i))
    session.export_report('~/Desktop/{}-output.docx')
```
